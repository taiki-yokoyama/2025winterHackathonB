# 設計書

## 概要

評価・フィードバックシステムは、チームメンバーが互いの作業に対してフィードバックを提供し、アクション項目を提案できるWebアプリケーションです。システムは2つの主要機能で構成されます：

1. **チーム機能**: チーム全体の計画共有とグループチャット
2. **個人評価機能**: 個別のコード/人格評価とアクション提案

システムは既存のプランページ（src/plan/index.php）とアクションページ（src/action/index.php）と統合され、完全なPDCAサイクルを実現します。

## アーキテクチャ

### システム構成

```
┌─────────────────────────────────────────────────────────┐
│                    フロントエンド                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ check.php    │  │ result.php   │  │ plan/action  │  │
│  │ (評価入力)    │  │ (評価閲覧)    │  │ (統合表示)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓ HTTP POST/GET
┌─────────────────────────────────────────────────────────┐
│                   バックエンド (PHP)                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │  評価処理ロジック                                   │  │
│  │  - フォームバリデーション                            │  │
│  │  - データ保存/取得                                  │  │
│  │  - セッション管理                                   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓ PDO
┌─────────────────────────────────────────────────────────┐
│                  データベース (MySQL)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────┐     │
│  │ team_    │  │ team_    │  │ individual_      │     │
│  │ plans    │  │ chats    │  │ evaluations      │     │
│  └──────────┘  └──────────┘  └──────────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 技術スタック

- **フロントエンド**: HTML, Tailwind CSS, JavaScript (バニラJS)
- **バックエンド**: PHP 8.x
- **データベース**: MySQL 8.x
- **データアクセス**: PDO (PHP Data Objects)

## コンポーネントとインターフェース

### 1. フロントエンドコンポーネント

#### 1.1 評価入力ページ (src/check/check.php)

**責務**:
- タブ切り替え機能（チーム/個人）
- チーム計画の入力と送信
- チームチャットの表示と投稿
- 個人評価フォームの表示と送信

**主要機能**:
- `switchTab(tabName)`: タブ切り替え処理
- チーム計画送信フォーム
- チャットメッセージ送信フォーム
- 個人評価送信フォーム（対象ユーザー選択、評価、コメント、アクション提案）

#### 1.2 評価閲覧ページ (src/check/result.php)

**責務**:
- 受け取った評価の表示
- サマリースコアの計算と表示
- 評価詳細の一覧表示

**主要機能**:
- 評価データの取得と表示
- 平均スコア計算
- 評価者情報の表示

#### 1.3 統合表示ページ

**プランページ (src/plan/index.php)**:
- チーム計画の表示（全メンバーの計画セクションに追加）

**アクションページ (src/action/index.php)**:
- アクション提案の表示（提案者名とタイムスタンプ付き）

### 2. バックエンドコンポーネント

#### 2.1 データベース接続 (src/dbconnect.php)

既存の接続設定を使用:
```php
$dsn = 'mysql:host=db;dbname=posse;charset=utf8';
$user = 'root';
$password = 'root';
$dbh = new PDO($dsn, $user, $password);
```

#### 2.2 評価処理ハンドラー

**チーム計画ハンドラー**:
- POST: チーム計画の保存
- GET: チーム計画の取得

**チームチャットハンドラー**:
- POST: メッセージの保存
- GET: メッセージ一覧の取得

**個人評価ハンドラー**:
- POST: 評価データの保存（��象ユーザー、コード評価、人格評価、コメント、アクション提案）
- GET: 評価データの取得

## データモデル

### 1. team_plans テーブル

チーム全体の計画を保存します。

```sql
CREATE TABLE team_plans (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    plan_text TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_created_at (created_at)
);
```

**フィールド説明**:
- `id`: 主キー
- `user_id`: 計画を作成したユーザーのID
- `plan_text`: 計画の内容
- `created_at`: 作成日時
- `updated_at`: 更新日時

### 2. team_chats テーブル

チーム全体のチャットメッセージを保存します。

```sql
CREATE TABLE team_chats (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    message TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_created_at (created_at)
);
```

**フィールド説明**:
- `id`: 主キー
- `user_id`: メッセージを送信したユーザーのID
- `message`: メッセージ内容
- `created_at`: 送信日時

### 3. individual_evaluations テーブル

個人評価データを保存します。

```sql
CREATE TABLE individual_evaluations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    evaluator_id INT NOT NULL,
    target_user_id INT NOT NULL,
    code_rating INT NOT NULL CHECK (code_rating BETWEEN 1 AND 4),
    code_comment TEXT,
    personality_rating INT NOT NULL CHECK (personality_rating BETWEEN 1 AND 4),
    personality_comment TEXT,
    action_proposal TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (target_user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_target_user (target_user_id, created_at),
    INDEX idx_evaluator (evaluator_id, created_at)
);
```

**フィールド説明**:
- `id`: 主キー
- `evaluator_id`: 評価を行ったユーザーのID
- `target_user_id`: 評価を受けるユーザーのID
- `code_rating`: コード面の評価（1-4）
- `code_comment`: コード面のコメント（任意）
- `personality_rating`: 人格面の評価（1-4）
- `personality_comment`: 人格面のコメント（任意）
- `action_proposal`: アクション提案（任意）
- `created_at`: 評価日時

### データ整合性制約

1. **外部キー制約**: 全てのuser_id参照は既存のusersテーブルを参照
2. **評価範囲制約**: code_ratingとpersonality_ratingは1-4の範囲
3. **カスケード削除**: ユーザー削除時に関連データも削除
4. **インデックス**: 検索パフォーマンス向上のため、よく使用されるカラムにインデックスを設定


## 正確性プロパティ

*プロパティとは、システムの全ての有効な実行において真であるべき特性または動作です。本質的には、システムが何をすべきかについての形式的な記述です。プロパティは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。*

### プロパティ1: チーム計画の保存整合性

*任意の*有効なチーム計画テキストとユーザーIDに対して、計画を保存した後にデータベースから取得すると、元のテキスト、ユーザーID、タイムスタンプが正しく保存されていなければならない

**検証: 要件 1.1, 9.1**

### プロパティ2: 空入力のバリデーション

*任意の*空文字列または空白文字のみで構成される文字列に対して、チーム計画またはチームチャットの送信を試みると、システムは送信を拒否しなければならない

**検証: 要件 1.4, 2.4**

### プロパティ3: チャットメッセージの保存整合性

*任意の*有効なチャットメッセージとユーザーIDに対して、メッセージを保存した後にデータベースから取得すると、元のメッセージ、送信者ID、タイムスタンプが正しく保存されていなければならない

**検証: 要件 2.1, 9.2**

### プロパティ4: メッセージのタイムスタンプ順序

*任意の*チャットメッセージのセットに対して、システムがメッセージを取得するとき、それらは作成タイムスタンプの昇順（古いものから新しいもの）で並べられていなければならない

**検証: 要件 2.3**

### プロパティ5: 対象ユーザー選択の不変条件

*任意の*時点において、個人評価フォームは正確に1人の対象ユーザーが選択されている状態でなければならない

**検証: 要件 3.5**

### プロパティ6: 評価データの保存整合性

*任意の*有効な個人評価データ（評価者ID、対象ユーザーID、コード評価、人格評価、オプションのコメント、オプションのアクション提案）に対して、評価を保存した後にデータベースから取得すると、全てのフィールドが正しく保存されていなければならない

**検証: 要件 4.4, 5.4, 8.2, 9.3**

### プロパティ7: 評価の取得フィルタリング

*任意の*対象ユーザーIDに対して、システムが評価を取得するとき、返される全ての評価レコードはそのユーザーIDを対象ユーザーとして持たなければならない

**検証: 要件 4.5, 5.5, 7.1**

### プロパティ8: アクション提案の保存と取得

*任意の*有効なアクション提案テキストに対して、評価と共に保存した後、対象ユーザーのアクションページから取得すると、提案テキスト、評価者名、タイムスタンプが正しく表示されなければならない

**検証: 要件 6.2, 6.3**

### プロパティ9: アクション提案のタイムスタンプ順序

*任意の*ユーザーに対する複数のアクション提案に対して、システムが提案を取得するとき、それらは作成タイムスタンプの降順（新しいものから古いもの）で並べられていなければならない

**検証: 要件 6.5**

### プロパティ10: 評価のタイムスタンプ順序

*任意の*ユーザーに対する複数の評価に対して、システムが評価を取得するとき、それらは作成タイムスタンプの降順（新しいものから古いもの）で並べられていなければならない

**検証: 要件 7.5**

### プロパティ11: 平均スコア計算の正確性

*任意の*評価セットに対して、システムが計算するコード評価の平均とは、全てのコード評価の合計をコード評価の数で割った値でなければならない。人格評価の平均も同様に計算されなければならない

**検証: 要件 7.3**

### プロパティ12: 必須フィールドのバリデーション

*任意の*評価フォーム送信に対して、コード評価（1-4）と人格評価（1-4）が提供されていない場合、システムは送信を拒否しなければならない

**検証: 要件 8.1**

### プロパティ13: SQLインジェクション防止

*任意の*ユーザー入力（SQLインジェクション攻撃を含む悪意のある文字列を含む）に対して、システムはプリペアドステートメントを使用してデータベースクエリを実行し、SQLインジェクションが発生しないようにしなければならない

**検証: 要件 9.5**

## エラーハンドリング

### 1. バリデーションエラー

**クライアントサイドバリデーション**:
- 空入力チェック（チーム計画、チャットメッセージ）
- 評価範囲チェック（1-4）
- 必須フィールドチェック

**サーバーサイドバリデーション**:
- 全てのクライアントサイドバリデーションを再実行
- データ型チェック
- 文字列長制限チェック
- 外部キー存在チェック

**エラーレスポンス**:
```php
[
    'success' => false,
    'errors' => [
        'field_name' => 'エラーメッセージ'
    ]
]
```

### 2. データベースエラー

**エラーハンドリング戦略**:
- PDO例外をキャッチ
- エラーをログファイルに記録
- ユーザーには一般的なエラーメッセージを表示
- 詳細なエラー情報は開発環境でのみ表示

**エラーレスポンス例**:
```php
try {
    // データベース操作
} catch (PDOException $e) {
    error_log("Database error: " . $e->getMessage());
    return [
        'success' => false,
        'message' => 'データベースエラーが発生しました。しばらくしてから再度お試しください。'
    ];
}
```

### 3. セッションエラー

**未認証ユーザー**:
- ログインページにリダイレクト
- 元のURLをセッションに保存（ログイン後に戻る）

**セッションタイムアウト**:
- セッション有効期限チェック
- タイムアウト時はログインページにリダイレクト

### 4. 権限エラー

**不正アクセス**:
- 他のユーザーのデータへの不正アクセスを防止
- 403 Forbiddenエラーを返す

## テスト戦略

### 1. ユニットテスト

**対象**:
- バリデーション関数
- データ変換関数
- 平均計算関数
- SQLクエリビルダー関数

**テストフレームワーク**: PHPUnit

**テスト例**:
```php
// バリデーションテスト
testEmptyInputValidation()
testRatingRangeValidation()
testSQLInjectionPrevention()

// 計算テスト
testAverageScoreCalculation()
testEmptyEvaluationSetAverage()

// データ整合性テスト
testEvaluationDataRoundTrip()
testChatMessageRoundTrip()
```

### 2. プロパティベーステスト

プロパティベーステストは、ランダムに生成された多様な入力に対してプロパティが成り立つことを検証します。

**テストライブラリ**: PHPUnit + Eris (PHPのプロパティベーステストライブラリ)

**設定**:
- 各プロパティテストは最低100回の反復を実行
- ランダムシードを記録して再現可能性を確保

**テスト対象プロパティ**:
- プロパティ1: チーム計画の保存整合性
- プロパティ2: 空入力のバリデーション
- プロパティ3: チャットメッセージの保存整合性
- プロパティ4: メッセージのタイムスタンプ順序
- プロパティ5: 対象ユーザー選択の不変条件
- プロパティ6: 評価データの保存整合性
- プロパティ7: 評価の取得フィルタリング
- プロパティ8: アクション提案の保存と取得
- プロパティ9: アクション提案のタイムスタンプ順序
- プロパティ10: 評価のタイムスタンプ順序
- プロパティ11: 平均スコア計算の正確性
- プロパティ12: 必須フィールドのバリデーション
- プロパティ13: SQLインジェクション防止

**プロパティテストの例**:
```php
/**
 * Feature: evaluation-feedback-system, Property 1: チーム計画の保存整合性
 */
public function testTeamPlanStorageConsistency()
{
    $this->forAll(
        Generator\string(),  // ランダムな計画テキスト
        Generator\int()      // ランダムなユーザーID
    )->then(function ($planText, $userId) {
        // 計画を保存
        $planId = saveTeamPlan($userId, $planText);
        
        // データベースから取得
        $retrieved = getTeamPlan($planId);
        
        // 元のデータと一致することを確認
        $this->assertEquals($planText, $retrieved['plan_text']);
        $this->assertEquals($userId, $retrieved['user_id']);
        $this->assertNotNull($retrieved['created_at']);
    });
}

/**
 * Feature: evaluation-feedback-system, Property 11: 平均スコア計算の正確性
 */
public function testAverageScoreCalculationAccuracy()
{
    $this->forAll(
        Generator\seq(Generator\choose(1, 4))  // 1-4の評価のランダムな配列
    )->then(function ($ratings) {
        if (empty($ratings)) {
            return; // 空の配列はスキップ
        }
        
        $expected = array_sum($ratings) / count($ratings);
        $actual = calculateAverageRating($ratings);
        
        $this->assertEquals($expected, $actual, '', 0.01);
    });
}
```

### 3. 統合テスト

**対象**:
- フォーム送信からデータベース保存までの完全なフロー
- データ取得から表示までの完全なフロー
- 既存ページ（plan/action）との統合

**テストシナリオ**:
1. チーム計画の送信と表示
2. チャットメッセージの送信と表示
3. 個人評価の送信と結果ページでの表示
4. アクション提案の送信とアクションページでの表示

### 4. セキュリティテスト

**対象**:
- SQLインジェクション攻撃
- XSS攻撃
- CSRF攻撃
- セッションハイジャック

**テスト方法**:
- 悪意のある入力パターンでテスト
- セキュリティスキャンツールの使用
- 手動ペネトレーションテスト

## 実装の考慮事項

### 1. パフォーマンス

**データベースクエリ最適化**:
- 適切なインデックスの使用
- N+1クエリ問題の回避
- ページネーション（大量データの場合）

**キャッシング**:
- ユーザー情報のセッションキャッシュ
- 頻繁にアクセスされるデータのキャッシュ

### 2. セキュリティ

**入力サニタイゼーション**:
- 全てのユーザー入力をエスケープ
- HTMLタグの除去または無害化

**認証・認可**:
- セッションベースの認証
- ユーザーIDの検証
- CSRF トークンの使用

**データベースセキュリティ**:
- プリペアドステートメントの使用
- 最小権限の原則
- 機密情報の暗号化

### 3. ユーザビリティ

**フィードバック**:
- 操作の成功/失敗を明確に表示
- ローディングインジケーター
- エラーメッセージの明確化

**レスポンシブデザイン**:
- モバイルフレンドリーなUI
- タッチ操作への対応

### 4. 保守性

**コード構造**:
- 関数の単一責任原則
- 再利用可能なコンポーネント
- 明確な命名規則

**ドキュメント**:
- コードコメント
- API ドキュメント
- データベーススキーマドキュメント

## 既存システムとの統合

### 1. プランページ統合

**変更点**:
- チーム計画データの取得クエリを追加
- 各メンバーの計画セクションにチーム計画を表示

**実装**:
```php
// src/plan/index.php の team ビューに追加
$teamPlans = getTeamPlans(); // 全てのチーム計画を取得
foreach ($teamPlans as $plan) {
    // 各メンバーのセクションに計画を表示
}
```

### 2. アクションページ統合

**変更点**:
- アクション提案データの取得クエリを追加
- 現在のユーザー向けの提案を表示

**実装**:
```php
// src/action/index.php に追加
$currentUserId = $_SESSION['user_id'];
$actionProposals = getActionProposals($currentUserId);
foreach ($actionProposals as $proposal) {
    // 提案を表示（評価者名、日付、提案内容）
}
```

### 3. セッション管理

**既存のセッション変数を使用**:
- `$_SESSION['user_id']`: 現在のユーザーID
- `$_SESSION['email']`: ユーザーのメールアドレス

### 4. データベース接続

**既存の接続を使用**:
- `src/dbconnect.php` をインクルード
- `$dbh` PDOインスタンスを使用
